<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="åŸºäºç§‹é˜³åˆ›å·´ä»æ³¢åˆ‡æ•™æ³•çš„ AI å¯¹è¯åŠ©æ‰‹">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>ChÃ¶gyam Trungpa æ•™æ³•çŸ¥è¯†åº“</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      background: #ffffff;
      min-height: 100vh;
      min-height: -webkit-calc(100vh);
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-justify-content: center;
      justify-content: center;
      -webkit-align-items: center;
      align-items: center;
      padding: 20px;
      padding: 15px;
      color: #333333;
    }

    .container {
      width: 100%;
      max-width: 800px;
      background: #ffffff;
      border: 1px solid #f0f0f0;
      border-radius: 16px;
      -webkit-box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      -moz-box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      height: 85vh;
      height: -webkit-calc(100vh - 30px);
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-flex-direction: column;
      -ms-flex-direction: column;
      flex-direction: column;
    }

    .header {
      background: #ffffff;
      color: #333333;
      padding: 24px 20px;
      text-align: center;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .header p {
      font-size: 13px;
      color: #666666;
    }

    .history-btn {
      padding: 8px 16px;
      background: #f5f5f5;
      border: 1px solid #e8e8e8;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      color: #666;
    }

    .history-btn:hover {
      background: #e8e8e8;
      color: #333;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #ffffff;
    }

    .message {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
    }

    .message.user {
      align-items: flex-end;
    }

    .message.assistant {
      align-items: flex-start;
    }

    .message-content {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 8px;
      line-height: 1.6;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .message.user .message-content {
      background: #f5f5f5;
      color: #333333;
      border: 1px solid #e8e8e8;
      border-bottom-right-radius: 4px;
    }

    .message.assistant .message-content {
      background: #ffffff;
      color: #333333;
      border: 1px solid #f0f0f0;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
    }

    .message-sources {
      font-size: 11px;
      color: #999999;
      margin-top: 5px;
      padding: 0 4px;
    }

    .input-container {
      padding: 20px;
      background: #ffffff;
      border-top: 1px solid #f0f0f0;
      display: flex;
      gap: 10px;
    }

    #messageInput {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #e8e8e8;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.2s;
      background: #fafafa;
    }

    #messageInput:focus {
      outline: none;
      border-color: #333333;
      background: #ffffff;
    }

    #sendButton {
      padding: 12px 24px;
      background: #333333;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    #sendButton:hover {
      background: #000000;
    }

    #sendButton:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .typing-indicator {
      display: none;
      align-items: center;
      gap: 5px;
      padding: 12px 16px;
      background: #f5f5f5;
      border: 1px solid #e8e8e8;
      border-radius: 8px;
      margin-bottom: 20px;
      width: fit-content;
    }

    .typing-indicator span {
      width: 6px;
      height: 6px;
      background: #333333;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.3;
      }
      30% {
        transform: translateY(-4px);
        opacity: 1;
      }
    }

    .welcome-message {
      text-align: center;
      color: #666666;
      margin-top: 20px;
      padding: 0 40px;
    }

    .welcome-message h2 {
      font-size: 18px;
      font-weight: 600;
      color: #333333;
      margin-bottom: 16px;
    }

    .history-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .history-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      width: 90%;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .history-header h2 {
      font-size: 20px;
      font-weight: 600;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #999;
      padding: 4px 8px;
    }

    .close-btn:hover {
      color: #333;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .history-item {
      padding: 12px 16px;
      background: #fafafa;
      border: 1px solid #f0f0f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .history-item:hover {
      background: #ffffff;
      border-color: #333;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .history-question {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
    }

    .history-time {
      font-size: 12px;
      color: #999;
    }

    .history-empty {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    @media (max-width: 600px) {
      .container {
        height: 90vh;
      }

      .message-content {
        max-width: 90%;
      }

      .welcome-message {
        padding: 0 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>ğŸ“š ChÃ¶gyam Trungpa æ•™æ³•çŸ¥è¯†åº“</h1>
        <p>åŸºäºåˆ›å·´ä»æ³¢åˆ‡ 10 éƒ¨æ–‡é›†çš„ AI å¯¹è¯åŠ©æ‰‹</p>
      </div>
      <button class="history-btn" onclick="showHistory()">ğŸ“– å†å²</button>
    </div>

    <div class="chat-container" id="chatContainer">
      <div class="welcome-message" id="welcomeMessage">
        <h2>ğŸ™ æ¬¢è¿ä½¿ç”¨</h2>
        <p>æ‚¨å¯ä»¥è‡ªç”±æé—®ä»»ä½•å…³äº ChÃ¶gyam Trungpa å–‡å˜›æ•™æ³•çš„é—®é¢˜ã€‚</p>
        <p style="margin-top: 24px; font-size: 13px; color: #999;">
          ğŸ’¡ åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œå¼€å§‹å¯¹è¯
        </p>
      </div>
      
      <div class="typing-indicator" id="typingIndicator">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>

    <div class="input-container">
      <input
        type="text"
        id="messageInput"
        placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..."
        autocomplete="off"
      >
      <button id="sendButton">å‘é€</button>
    </div>
  </div>

  <div class="history-modal" id="historyModal">
    <div class="history-content">
      <div class="history-header">
        <h2>ğŸ“– å†å²å¯¹è¯</h2>
        <button class="close-btn" onclick="hideHistory()">Ã—</button>
      </div>
      <div class="history-list" id="historyList">
        <div class="history-empty">æš‚æ— å†å²å¯¹è¯</div>
      </div>
    </div>
  </div>

  <script>
    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const historyModal = document.getElementById('historyModal');
    const historyList = document.getElementById('historyList');

    let chatHistory = [];

    // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
    function addMessage(role, content, sources = []) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${role}`;

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.textContent = content;

      messageDiv.appendChild(contentDiv);

      if (sources && sources.length > 0) {
        const sourcesDiv = document.createElement('div');
        sourcesDiv.className = 'message-sources';
        sourcesDiv.textContent = `æ¥æº: ${sources.join(', ')}`;
        messageDiv.appendChild(sourcesDiv);
      }

      chatContainer.insertBefore(messageDiv, typingIndicator);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      return messageDiv;
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;

      // éšè—æ¬¢è¿æ¶ˆæ¯
      welcomeMessage.style.display = 'none';

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      addMessage('user', message);
      chatHistory.push({ role: 'user', content: message, timestamp: new Date().toISOString() });

      // æ¸…ç©ºè¾“å…¥æ¡†
      messageInput.value = '';
      sendButton.disabled = true;

      // æ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨
      typingIndicator.style.display = 'flex';
      chatContainer.scrollTop = chatContainer.scrollHeight;

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: message,
            history: chatHistory
          })
        });

        const data = await response.json();

        if (data.error) {
          addMessage('assistant', `é”™è¯¯: ${data.error}`);
        } else {
          addMessage('assistant', data.response, data.sources);
          chatHistory.push({ role: 'assistant', content: data.response, timestamp: new Date().toISOString() });
          
          // ä¿å­˜åˆ°å†å²è®°å½•
          saveHistory(message, data.response);
        }
      } catch (error) {
        addMessage('assistant', `ç½‘ç»œé”™è¯¯: ${error.message}`);
      } finally {
        typingIndicator.style.display = 'none';
        sendButton.disabled = false;
        messageInput.focus();
      }
    }

    // æ˜¾ç¤ºå†å²è®°å½•
    function showHistory() {
      const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
      
      if (history.length === 0) {
        historyList.innerHTML = '<div class="history-empty">æš‚æ— å†å²å¯¹è¯</div>';
      } else {
        historyList.innerHTML = history.map(item => `
          <div class="history-item" onclick="loadHistory('${encodeURIComponent(item.question)}')">
            <div class="history-question">${item.question}</div>
            <div class="history-time">${new Date(item.timestamp).toLocaleString('zh-CN')}</div>
          </div>
        `).join('');
      }
      
      historyModal.style.display = 'flex';
    }

    // éšè—å†å²è®°å½•
    function hideHistory() {
      historyModal.style.display = 'none';
    }

    // ä¿å­˜å†å²è®°å½•
    function saveHistory(question, answer) {
      const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
      history.unshift({
        question: question,
        answer: answer,
        timestamp: new Date().toISOString()
      });
      
      // åªä¿ç•™æœ€è¿‘ 100 æ¡
      if (history.length > 100) {
        history.splice(100);
      }
      
      localStorage.setItem('chatHistory', JSON.stringify(history));
    }

    // åŠ è½½å†å²å¯¹è¯
    function loadHistory(encodedQuestion) {
      const question = decodeURIComponent(encodedQuestion);
      messageInput.value = question;
      hideHistory();
      sendMessage();
    }

    // äº‹ä»¶ç›‘å¬
    sendButton.addEventListener('click', sendMessage);

    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    historyModal.addEventListener('click', (e) => {
      if (e.target === historyModal) {
        hideHistory();
      }
    });
  </script>
</body>
</html>
